library(shiny)
library(fitzRoy)
library(dplyr)
library(ggplot2)
library(patchwork)
library(tidyr)

# Fetch player stats from AFL Tables
fetch_and_prepare_data <- function(seasons = 2010:2024) {
  fetch_player_stats_afltables(season = seasons)
}

# UI Layout
ui <- fluidPage(
  titlePanel("Parlay Maker"),
  sidebarLayout(
    sidebarPanel(
      sliderInput("season_range", "Select Seasons:", min = 2010, max = 2024, value = c(2010, 2024), sep = ""),
      selectInput("team", "Select Team:", choices = NULL),
      selectInput("player", "Select Player:", choices = NULL),
      selectInput("opponent", "Select Opponent:", choices = NULL),
      numericInput("goals_min", "Minimum Goals:", value = 0, min = 0),
      numericInput("disposals_min", "Minimum Disposals:", value = 0, min = 0)
    ),
    mainPanel(
      verbatimTextOutput("statistics"),
      verbatimTextOutput("historical_prob"),
      plotOutput("hist_plot")
    )
  )
)

# Server Logic
server <- function(input, output, session) {
  match_data <- reactive({
    fetch_and_prepare_data(seq(input$season_range[1], input$season_range[2]))
  })
  
  # Update team list dynamically
  observe({
    teams <- sort(unique(c(match_data()$Home.team, match_data()$Away.team)))
    updateSelectInput(session, "team", choices = teams, selected = teams[1])
  })
  
  # Update player list based on selected team
  observeEvent(input$team, {
    players <- match_data() %>%
      filter(Playing.for == input$team) %>%
      distinct(First.name, Surname) %>%
      mutate(player_name = paste(First.name, Surname)) %>%
      pull(player_name)
    updateSelectInput(session, "player", choices = c("All players", sort(players)))
  })
  
  # Update opponent list based on selected team
  observeEvent(input$team, {
    opponents <- match_data() %>%
      filter(Home.team == input$team | Away.team == input$team) %>%
      distinct(Home.team, Away.team) %>%
      pivot_longer(cols = everything(), values_to = "team") %>%
      filter(team != input$team) %>%
      pull(team) %>%
      unique()
    updateSelectInput(session, "opponent", choices = c("All teams", sort(opponents)))
  })
  
  # Render performance statistics
  output$statistics <- renderPrint({
    req(match_data(), input$team)
    
    team_stats <- match_data() %>%
      filter(Playing.for == input$team)
    
    if (input$opponent != "All teams") {
      team_stats <- team_stats %>%
        filter(Home.team == input$opponent | Away.team == input$opponent)
    }
    
    if (input$player != "All players") {
      selected_player <- strsplit(input$player, " ")[[1]]
      first_name <- selected_player[1]
      last_name <- selected_player[2]
      
      team_stats <- team_stats %>%
        filter(
          First.name == first_name,
          Surname == last_name,
          Goals >= input$goals_min,
          Disposals >= input$disposals_min
        )
    }
    
    team_stats <- team_stats %>%
      mutate(
        win = ifelse((Playing.for == Home.team & Home.score > Away.score) | 
                       (Playing.for == Away.team & Away.score > Home.score), 1, 0),
        margin = ifelse(Playing.for == Home.team, Home.score - Away.score, Away.score - Home.score)
      )
    
    win_percentage <- team_stats %>%
      summarise(win_percent = sum(win) / n() * 100) %>%
      pull(win_percent) %>%
      round(1)
    
    average_winning_margin <- team_stats %>%
      filter(win == 1) %>%
      summarise(avg_winning_margin = mean(margin, na.rm = TRUE)) %>%
      pull(avg_winning_margin) %>%
      round(1)
    
    average_losing_margin <- team_stats %>%
      filter(win == 0) %>%
      summarise(avg_losing_margin = mean(abs(margin), na.rm = TRUE)) %>%
      pull(avg_losing_margin) %>%
      round(1)
    
    cat("Performance Summary:\n")
    cat("---------------------\n")
    if (input$player == "All players") {
      cat("Team-Level Statistics:\n")
    } else {
      cat(sprintf("Player: %s\n", input$player))
    }
    cat(sprintf("Win Percentage: %.1f%%\n", win_percentage))
    cat(sprintf("Average Winning Margin: %.1f points\n", average_winning_margin))
    cat(sprintf("Average Losing Margin: %.1f points\n", average_losing_margin))
  })
  
  # Compute historical probability based on selected filters
  output$historical_prob <- renderText({
    req(match_data(), input$team)
    
    team_stats <- match_data() %>%
      filter(Playing.for == input$team)
    
    if (input$opponent != "All teams") {
      team_stats <- team_stats %>%
        filter(Home.team == input$opponent | Away.team == input$opponent)
    }
    
    if (input$player == "All players") {
      # Calculate team totals
      team_totals <- team_stats %>%
        group_by(Date) %>%
        summarise(TotalGoals = sum(Goals, na.rm = TRUE), TotalDisposals = sum(Disposals, na.rm = TRUE))
      
      prob_goals <- sum(team_totals$TotalGoals >= input$goals_min, na.rm = TRUE) / nrow(team_totals) * 100
      prob_disposals <- sum(team_totals$TotalDisposals >= input$disposals_min, na.rm = TRUE) / nrow(team_totals) * 100
      
      sprintf("Historical probability of the team scoring at least %d goals: %.1f%%\nHistorical probability of the team reaching %d disposals: %.1f%%", 
              input$goals_min, prob_goals, input$disposals_min, prob_disposals)
      
    } else {
      selected_player <- strsplit(input$player, " ")[[1]]
      first_name <- selected_player[1]
      last_name <- selected_player[2]
      
      player_stats <- team_stats %>%
        filter(First.name == first_name, Surname == last_name)
      
      prob_goals <- sum(player_stats$Goals >= input$goals_min, na.rm = TRUE) / nrow(player_stats) * 100
      prob_disposals <- sum(player_stats$Disposals >= input$disposals_min, na.rm = TRUE) / nrow(player_stats) * 100
      
      sprintf("Historical probability of %s scoring at least %d goals: %.1f%%\nHistorical probability of %s reaching %d disposals: %.1f%%", 
              input$player, input$goals_min, prob_goals, input$player, input$disposals_min, prob_disposals)
    }
  })
  
  # Visualization: Histogram of goals
  output$hist_plot <- renderPlot({
    req(match_data(), input$team)
    
    team_stats <- match_data() %>%
      filter(Playing.for == input$team)
    
    ggplot(team_stats, aes(x = Goals)) +
      geom_histogram(binwidth = 1, fill = "steelblue", alpha = 0.7) +
      geom_vline(xintercept = input$goals_min, color = "red", linetype = "dashed") +
      labs(title = "Distribution of Goals Scored", x = "Goals", y = "Frequency") +
      theme_minimal()
  })
}

# Run the Shiny App
shinyApp(ui = ui, server = server)
